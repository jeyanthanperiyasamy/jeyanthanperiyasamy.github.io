<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tesco Collection ‚Äî Mobile Responsive (Chat + PayPal Mock)</title>
  <style>
    :root { --blue:#00539f; --red:#d7263d; --ink:#111; --muted:#666; --bg:#f6f7fb; --line:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:var(--bg); }
    .no-scroll { overflow:hidden; height:100vh; }

    /* Top Nav */
    .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--line);box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .nav{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .logo{font-weight:900;font-size:1.2rem;color:var(--blue)}
    .search{flex:1}
    .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
    .cart-btn{position:relative;background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer}
    .cart-count{position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;font-size:12px;font-weight:700;padding:2px 6px;border-radius:999px}

    /* Header */
    header{text-align:center;padding:28px 16px 8px}
    header h1{margin:0 0 6px;color:var(--blue);font-size:clamp(1.6rem,4.5vw,2.2rem)}
    header p{margin:0;color:var(--muted);font-size:.95rem}

    /* Grid */
    .wrap{max-width:1200px;margin:16px auto;padding:0 16px 120px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:768px){ .grid{grid-template-columns:repeat(2,1fr); gap:12px} }
    @media (max-width:480px){ .grid{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
    .media{height:180px;display:grid;place-items:center;font-size:2.2rem;background:#fafafa}
    .meta{padding:12px;display:grid;gap:6px}
    .brand{font-size:.72rem;font-weight:800;color:#fff;background:var(--blue);padding:3px 8px;border-radius:999px;width:fit-content}
    .title{font-weight:800}
    .unit{color:var(--muted);font-size:.9rem}
    .price-row{display:flex;justify-content:space-between;align-items:center}
    .price{color:var(--red);font-weight:900}
    .add{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:8px 12px;font-weight:800;cursor:pointer}

    /* Checkout Card */
    .checkout-section{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);max-width:1200px;margin:16px auto;padding:16px}
    .checkout-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .checkout-header h2{margin:0;color:var(--blue);font-size:1.2rem}
    .checkout-total{font-weight:900;color:var(--red)}
    .cart-list{display:grid;gap:10px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:10px}
    .qty{display:flex;gap:6px;align-items:center}
    .qty button{width:32px;height:32px;border:none;background:#f3f4f6;font-weight:900;cursor:pointer;border-radius:8px}
    @media (max-width:768px){ .qty button{width:40px;height:40px} }
    #paypal-button-container{margin-top:12px}
    .pp-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:0;cursor:pointer;font-weight:900;background:linear-gradient(45deg,#0070ba,#003087);color:#fff;box-shadow:0 8px 20px rgba(0,112,186,.35)}
    .pp-btn:hover{filter:brightness(1.05);transform:translateY(-1px)}

    .toast{position:fixed;top:16px;right:16px;background:var(--red);color:#fff;padding:10px 14px;border-radius:10px;font-weight:900;box-shadow:0 8px 24px rgba(0,0,0,.12);transform:translateX(120%);transition:transform .3s ease;z-index:90}

    /* Chat launcher + sheet */
    .chat-launcher{position:fixed;right:18px;bottom:calc(18px + env(safe-area-inset-bottom));z-index:65}
    .chat-fab{width:56px;height:56px;border-radius:999px;border:0;background:var(--blue);color:#fff;font-size:22px;box-shadow:0 8px 24px rgba(0,0,0,.15);cursor:pointer}

    .chat-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:60}
    .chat-backdrop.show{opacity:1;pointer-events:auto}

    .chat-panel{position:fixed;right:20px;bottom:80px;width:360px;max-height:70vh;display:none;flex-direction:column;border:1px solid var(--line);border-radius:16px;background:#fff;box-shadow:0 12px 36px rgba(0,0,0,.25);transform:translateY(10px);opacity:0;transition:transform .2s ease,opacity .2s ease;z-index:70}
    .chat-panel.open{transform:translateY(0);opacity:1}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#f9fafb;color:var(--blue);font-weight:700}
    .chat-body{padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);padding-bottom:max(10px,env(safe-area-inset-bottom))}
    .chat-input input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
    .chat-input button{padding:10px 14px;border-radius:10px;border:0;font-weight:800;background:var(--blue);color:#fff;cursor:pointer}

    .msg{padding:10px 12px;border-radius:12px;max-width:85%}
    .msg.user{background:#e8f1fb;align-self:flex-end}
    .msg.bot{background:#f3f4f6;align-self:flex-start}

    .product{border:1px solid var(--line);padding:10px;border-radius:10px;margin:6px 0;background:#fff}
    .product-title{font-weight:800}
    .muted{color:var(--muted);font-size:.9rem}
    .pp-link{display:inline-block;margin-top:8px;padding:8px 12px;background:#0070ba;color:#fff;border-radius:999px;text-decoration:none;font-size:.9rem;box-shadow:0 6px 16px rgba(0,112,186,.35)}
    .pp-link:hover{filter:brightness(1.05);transform:translateY(-1px)}

    @media (max-width:768px){
      .chat-panel{left:0;right:0;bottom:0;width:100%;max-height:70vh;border-radius:16px 16px 0 0}
      .media{height:160px;font-size:2rem}
      .grid{gap:12px}
    }
    @media (max-width:480px){
      .media{height:140px;font-size:1.8rem}
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <div class="nav">
      <div class="logo">Tesco Collection</div>
      <div class="search"><input id="searchInput" type="search" placeholder="Search products‚Ä¶" autocomplete="off" /></div>
      <button id="openCart" class="cart-btn">üõí<span id="cartCount" class="cart-count">0</span></button>
    </div>
  </div>

  <!-- Header -->
  <header>
    <h1>Tesco Collection</h1>
    <p>Everyday groceries and trusted brands ‚Äî add to cart and pay with PayPal directly.</p>
  </header>

  <!-- Product Grid -->
  <div class="wrap"><div id="grid" class="grid"></div></div>

  <!-- Checkout -->
  <section class="checkout-section">
    <div class="checkout-header">
      <h2>Your Cart</h2>
      <div class="checkout-total" id="checkoutTotal">$0.00</div>
    </div>
    <div id="cartList" class="cart-list"></div>
    <div id="paypal-button-container"></div>
  </section>

  <div id="toast" class="toast">Added to cart</div>

  <!-- Chat launcher -->
  <div class="chat-launcher">
    <button id="chatFab" class="chat-fab" aria-label="Open chat">üí¨</button>
  </div>

  <!-- Chat sheet -->
  <div id="chatPanel" class="chat-panel" role="dialog" aria-modal="true" aria-labelledby="chatTitle">
    <div class="chat-header">
      <span id="chatTitle">Shopping Assistant</span>
      <button id="chatClose" class="cart-btn" style="padding:6px 8px">‚úï</button>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <form id="chatForm" class="chat-input">
      <input id="chatInput" type="text" placeholder="Try: snacks under $10, fruit, dairy‚Ä¶" autocomplete="off" />
      <button id="chatSend" type="button">Send</button>
    </form>
  </div>
  <div id="chatBackdrop" class="chat-backdrop" aria-hidden="true"></div>

<script>
  /* ---------- Mock catalog ---------- */
  const PRODUCTS = [];
  const categories = ['Fruit','Dairy','Bakery','Veg','Pantry','Drinks','Snacks','Tech','Sport','Home'];
  const icons = ['üçé','ü•õ','üçû','ü•ï','ü•´','ü•§','üç´','üì±','üëü','üßª'];
  for (let i = 1; i <= 50; i++) {
    const cat = categories[i % categories.length];
    const icon = icons[i % icons.length];
    PRODUCTS.push({ id:'P'+i, name:`Product ${i}`, icon, category:cat, unit:'1 unit', price:+(Math.random()*20+1).toFixed(2) });
  }

  /* ---------- DOM ---------- */
  const gridEl = document.getElementById('grid');
  const searchInput = document.getElementById('searchInput');
  const cartCountEl = document.getElementById('cartCount');
  const cartList = document.getElementById('cartList');
  const checkoutTotal = document.getElementById('checkoutTotal');
  const toastEl = document.getElementById('toast');

  /* ---------- Grid render + search ---------- */
  function card(p){
    const el=document.createElement('article');
    el.className='card';
    el.innerHTML = `
      <div class="media">${p.icon}</div>
      <div class="meta">
        <span class="brand">TESCO</span>
        <div class="title">${p.name}</div>
        <div class="unit">${p.unit}</div>
        <div class="price-row">
          <div class="price">$${p.price.toFixed(2)}</div>
          <button class="add" data-id="${p.id}">Add</button>
        </div>
      </div>`;
    return el;
  }
  function renderGrid(list = PRODUCTS){
    if(!gridEl) return;
    gridEl.innerHTML='';
    list.forEach(p=>gridEl.appendChild(card(p)));
  }
  renderGrid();

  searchInput.addEventListener('input', ()=>{
    const q = searchInput.value.trim().toLowerCase();
    const filtered = q
      ? PRODUCTS.filter(p => (`${p.name} ${p.category}`).toLowerCase().includes(q))
      : PRODUCTS;
    renderGrid(filtered);
  });

  /* ---------- Cart + PayPal ---------- */
  const cart = new Map();
  function money(n){ return `$${(+n).toFixed(2)}`; }
  function calc(){
    let items=0,total=0;
    cart.forEach((q,id)=>{ const p=PRODUCTS.find(x=>x.id===id); items+=q; total+=q*p.price; });
    return {items,total};
  }
  function updateCart(){
    const {items,total}=calc();
    cartCountEl.textContent = items;
    checkoutTotal.textContent = money(total);
    cartList.innerHTML = '';
    cart.forEach((q,id)=>{
      const p=PRODUCTS.find(x=>x.id===id);
      const row=document.createElement('div');
      row.className='cart-item';
      row.innerHTML = `
        <div>${p.icon} ${p.name}</div>
        <div class="qty">
          <button data-act="dec" data-id="${id}">-</button>
          <span>${q}</span>
          <button data-act="inc" data-id="${id}">+</button>
        </div>
        <div>${money(p.price*q)}</div>`;
      cartList.appendChild(row);
    });
  }
  function toast(msg){
    if(!toastEl) return;
    toastEl.textContent = '‚úì ' + msg;
    toastEl.style.transform = 'translateX(0)';
    setTimeout(()=> toastEl.style.transform = 'translateX(120%)', 1800);
  }

  // Add to cart from grid
  gridEl.addEventListener('click', (e)=>{
    if(e.target.classList.contains('add')){
      const id = e.target.dataset.id;
      cart.set(id, (cart.get(id)||0)+1);
      updateCart();
      const p=PRODUCTS.find(x=>x.id===id);
      toast(`${p.name} added`);
    }
  });

  // Change qty in cart
  cartList.addEventListener('click', (e)=>{
    const act = e.target.dataset.act;
    const id = e.target.dataset.id;
    if(!act || !id) return;
    if(act==='inc'){ cart.set(id,(cart.get(id)||0)+1); }
    if(act==='dec'){ const q=(cart.get(id)||0)-1; if(q>0) cart.set(id,q); else cart.delete(id); }
    updateCart();
  });

  // Stage PayPal URL
  const PAYPAL_STAGE_URL = "https://www.stage2d0068.stage.paypal.com/checkoutweb/?token=EC-TESTTOKEN&modxo_redirect_reason=test&dumbledoreEligible=1";
  function generatePayPalUrl(items){
    const enriched = items.map(it=>{
      const p=PRODUCTS.find(x=>x.id===it.id) || {};
      return { id: it.id, name: p.name || it.id, qty: it.qty||1, price: +(p.price||0) };
    });
    const total = +enriched.reduce((s,i)=> s + i.price * i.qty, 0).toFixed(2);
    const payload = encodeURIComponent(JSON.stringify({ items: enriched, total }));
    return `${PAYPAL_STAGE_URL}&mock_payload=${payload}`;
  }

  // Render PayPal button for cart
  (function renderPayPalButton(){
    const c=document.getElementById('paypal-button-container');
    c.innerHTML = '<button id="ppbtn" class="pp-btn" type="button">Pay with PayPal</button>';
    document.getElementById('ppbtn').addEventListener('click', ()=>{
      const {total}=calc(); if(total<=0){ alert('Your cart is empty.'); return; }
      const items = Array.from(cart.entries()).map(([id,qty])=>({id,qty}));
      window.location.href = generatePayPalUrl(items);
    });
  })();
  updateCart();

  /* ---------- Chat ---------- */
  const chatFab = document.getElementById('chatFab');
  const chatPanel = document.getElementById('chatPanel');
  const chatClose = document.getElementById('chatClose');
  const chatBody = document.getElementById('chatBody');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatBackdrop = document.getElementById('chatBackdrop');
  const chatSend = document.getElementById('chatSend');

  function addMsg(html, who='bot'){
    const div = document.createElement('div');
    div.className = 'msg '+who;
    div.innerHTML = html;
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  function productsHtml(list){
    return list.map(p=>{
      const perItemUrl = generatePayPalUrl([{id:p.id, qty:1}]);
      return `
      <div class="product">
        ${p.icon} <span class="product-title">${p.name}</span><br/>
        <span class="muted">${p.category} ‚Ä¢ ${p.unit}</span><br/>
        <strong>$${p.price.toFixed(2)}</strong><br/>
        <a class="pp-link" href="${perItemUrl}" target="_self">Checkout with PayPal</a>
      </div>`;
    }).join('');
  }
  function showProducts(list, prompt){
    if(!list.length){ addMsg(`No matches for <b>${prompt}</b>. Try another query.`, 'bot'); return; }
    const allUrl = generatePayPalUrl(list.map(p=>({id:p.id, qty:1})));
    addMsg(`
      I found <b>${list.length}</b> item(s) for <b>${prompt}</b>.<br/>
      <a class="pp-link" href="${allUrl}" target="_self">Pay for all shown with PayPal</a>
      ${productsHtml(list)}
    `,'bot');
  }
  function filterProducts(q){
    const query = (q||'').toLowerCase();
    let list = PRODUCTS.slice();

    // Price: under $X or under X
    const m = query.match(/under\s*\$?(\d+(?:\.\d+)?)/i);
    if(m){ const cap = parseFloat(m[1]); if(!Number.isNaN(cap)){ list = list.filter(p=> p.price <= cap); } }

    // Category
    const lc = categories.map(c=>c.toLowerCase());
    for(const c of lc){ if(query.includes(c)){ list = list.filter(p=> p.category.toLowerCase()===c); break; } }

    // Free-text (excluding the 'under' phrase)
    const cleaned = query.replace(/under\s*\$?\d+(?:\.\d+)?/i,' ').replace(/[^\w\s]/g,' ');
    const tokens = cleaned.split(/\s+/).filter(Boolean);
    if(tokens.length){ list = list.filter(p=> tokens.every(t => (`${p.name} ${p.category}`).toLowerCase().includes(t))); }

    return list.slice(0,8);
  }

  function bootChat(){
    if(chatBody.dataset.boot) return;
    chatBody.dataset.boot = '1';
    addMsg(`<b>Hi! I can find products and check you out with PayPal.</b><br/>
            Try queries like <i>snacks under $10</i> or <i>fruit</i>.`, 'bot');
    addMsg(productsHtml(PRODUCTS.slice(0,6)),'bot');
  }

  // Open/close chat
  function openChat(){
    chatPanel.style.display='flex';
    requestAnimationFrame(()=>{
      chatPanel.classList.add('open');
      chatBackdrop.classList.add('show');
    });
    document.body.classList.add('no-scroll');
    bootChat();
    chatInput.focus();
  }
  function closeChat(){
    chatPanel.classList.remove('open');
    chatBackdrop.classList.remove('show');
    document.body.classList.remove('no-scroll');
    setTimeout(()=>{ chatPanel.style.display='none'; }, 200);
  }
  chatFab.addEventListener('click', openChat);
  chatClose.addEventListener('click', closeChat);
  chatBackdrop.addEventListener('click', closeChat);

  // iOS swipe-to-close
  let startY=null, currentY=null, dragging=false;
  chatPanel.addEventListener('touchstart',(e)=>{
    if(e.touches.length!==1) return;
    startY=e.touches[0].clientY; dragging=true; chatPanel.style.transition='none';
  });
  chatPanel.addEventListener('touchmove',(e)=>{
    if(!dragging) return;
    currentY=e.touches[0].clientY; const dy=Math.max(0, currentY-startY);
    chatPanel.style.transform=`translateY(${dy}px)`;
  });
  chatPanel.addEventListener('touchend',()=>{
    if(!dragging) return; dragging=false; chatPanel.style.transition='';
    const dy=Math.max(0,(currentY||0)-(startY||0));
    if(dy>120){ closeChat(); chatPanel.style.transform=''; }
    else { chatPanel.style.transform=''; chatPanel.classList.add('open'); }
  });

  // Chat send
  function handleChatSend(){
    const text = chatInput.value.trim();
    if(!text) return;
    addMsg(text,'user');
    chatInput.value='';
    const results = filterProducts(text);
    showProducts(results, text);
  }
  chatForm.addEventListener('submit', (e)=>{ e.preventDefault(); handleChatSend(); });
  chatSend.addEventListener('click', handleChatSend);
</script>
</body>
</html>
