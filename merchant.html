<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tesco Collection with Chat + PayPal Mock</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    .chat-launcher { position: fixed; right: 20px; bottom: 20px; z-index:100; }
    .chat-fab { width: 56px; height: 56px; border-radius: 50%; background:#00539f; color:#fff; font-size:24px; border:none; cursor:pointer; }
    .chat-panel { position: fixed; right:20px; bottom:80px; width:350px; max-height:70vh; display:none; flex-direction:column; border:1px solid #ccc; border-radius:12px; background:#fff; box-shadow:0 4px 20px rgba(0,0,0,.2); transform: translateY(10px); opacity:0; transition: transform .2s ease, opacity .2s ease; z-index: 70; }
    .chat-panel.open { transform: translateY(0); opacity:1; }
    .chat-backdrop { position: fixed; inset:0; background: rgba(0,0,0,.35); opacity:0; pointer-events:none; transition: opacity .2s ease; z-index:60; }
    .chat-backdrop.show { opacity:1; pointer-events:auto; }
    @media (max-width: 768px){
      .chat-panel { left:0; right:0; bottom:0; width:100%; max-height:65vh; border-radius:16px 16px 0 0; }
      .chat-header { cursor: grab; }
    }
    .chat-header { background:#00539f; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .chat-body { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
    .msg { padding:8px 12px; border-radius:12px; max-width:80%; }
    .msg.user { background:#e0f2ff; align-self:flex-end; }
    .msg.bot { background:#f0f0f0; align-self:flex-start; }
    .chat-input { display:flex; border-top:1px solid #ddd; }
    .chat-input input { flex:1; padding:10px; border:none; outline:none; }
    .chat-input button { padding:10px; border:none; background:#00539f; color:#fff; cursor:pointer; }
    .product { border:1px solid #ddd; padding:8px; border-radius:8px; margin:4px 0; }
    .product-title { font-weight:bold; }
    .pp-link { display:inline-block; margin-top:6px; padding:6px 10px; background:#0070ba; color:#fff; border-radius:6px; text-decoration:none; font-size:0.9rem; }
    @media(max-width:600px){ .chat-panel { width:90%; right:5%; bottom:100px; } }
    /* ===== Main page styles ===== */
    .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e5e7eb;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .nav{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .logo{font-weight:900;font-size:1.2rem;color:#00539f}
    .search{flex:1}
    .search input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
    header{padding:32px 16px 8px;text-align:center}
    header h1{margin:0 0 6px 0;color:#00539f}
    header p{margin:0;color:#666}
    .wrap{max-width:1200px;margin:16px auto;padding:0 16px 120px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media(max-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
    .media{height:200px;display:grid;place-items:center;font-size:2.4rem;background:#fafafa}
    .meta{padding:12px;display:grid;gap:6px}
    .brand{font-size:.75rem;font-weight:800;color:#fff;background:#00539f;padding:3px 8px;border-radius:999px;width:fit-content}
    .title{font-weight:800}
    .unit{color:#666}
    .price-row{display:flex;justify-content:space-between;align-items:center}
    .price{color:#d7263d;font-weight:900}
    .add{background:#00539f;color:#fff;border:none;border-radius:8px;padding:8px 12px;font-weight:800;cursor:pointer}
    .checkout-section{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);max-width:1200px;margin:16px auto;padding:16px}
    .checkout-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .checkout-total{font-weight:900;color:#d7263d}
    .cart-list{display:grid;gap:10px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    .qty{display:flex;gap:6px;align-items:center}
    .qty button{width:26px;height:26px;border:none;background:#f3f4f6;font-weight:900;cursor:pointer;border-radius:6px}
    #paypal-button-container{margin-top:12px}
    .pp-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:0;cursor:pointer;font-weight:900;background:linear-gradient(45deg,#0070ba,#003087);color:#fff;box-shadow:0 8px 20px rgba(0,112,186,.35)}
    .toast{position:fixed;top:16px;right:16px;background:#d7263d;color:#fff;padding:10px 14px;border-radius:10px;font-weight:900;box-shadow:0 8px 24px rgba(0,0,0,.12);transform:translateX(120%);transition:transform .3s ease;z-index:90}
  </style>
</head>
<body>
    <!-- ===== Main page UI ===== -->
  <div class="topbar"><div class="nav"><div class="logo">Tesco Collection</div><div class="search"><input id="searchInput" type="search" placeholder="Search products‚Ä¶" /></div><button id="openCart" class="cart-btn" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer">üõí <span id="cartCount" style="background:#d7263d;color:#fff;padding:2px 6px;border-radius:999px;font-weight:900;font-size:12px;">0</span></button></div></div>
  <header><h1>Tesco Collection</h1><p>Everyday groceries and trusted brands ‚Äî add to cart and pay with PayPal directly.</p></header>
  <div class="wrap"><div id="grid" class="grid"></div></div>
  <section class="checkout-section"><div class="checkout-header"><h2 style="margin:0;color:#00539f">Your Cart</h2><div class="checkout-total" id="checkoutTotal">$0.00</div></div><div id="cartList" class="cart-list"></div><div id="paypal-button-container"></div></section>
  <div id="toast" class="toast">Added to cart</div>

  <!-- ===== Chat launcher ===== -->
  <div class="chat-launcher">
    <button id="chatFab" class="chat-fab">üí¨</button>
  </div>
  <div id="chatPanel" class="chat-panel">
    <div class="chat-header">Shopping Assistant <button id="chatClose" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">‚úï</button></div>
    <div id="chatBody" class="chat-body"></div>
    <form id="chatForm" class="chat-input">
      <input id="chatInput" type="text" placeholder="Ask for products..." />
      <button id="chatSend" type="button">Send</button>
    </form>
  </div>
  <div id="chatBackdrop" class="chat-backdrop" aria-hidden="true"></div>

<script>
  const PRODUCTS = [];
  const categories = ['Fruit','Dairy','Bakery','Veg','Pantry','Drinks','Snacks'];
  const icons = ['üçé','ü•õ','üçû','ü•ï','ü•´','ü•§','üç´'];
  for(let i=1;i<=30;i++){
    const cat = categories[i % categories.length];
    const icon = icons[i % icons.length];
    PRODUCTS.push({id:'P'+i, name:`Product ${i}`, icon, category:cat, price:(Math.random()*20+1).toFixed(2)});
  }

  const PAYPAL_STAGE_URL = "https://www.stage2d0068.stage.paypal.com/checkoutweb/?token=EC-9T916010XH738845D&modxo_redirect_reason=test&dumbledoreEligible=1";

  const chatFab = document.getElementById('chatFab');
  const chatPanel = document.getElementById('chatPanel');
  const chatClose = document.getElementById('chatClose');
  const chatBody = document.getElementById('chatBody');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatBackdrop = document.getElementById('chatBackdrop');
  const chatSend = document.getElementById('chatSend');

  /* ===== Main page logic (grid + cart + PayPal) ===== */
  const gridEl = document.getElementById('grid');
  function card(p){
    const el=document.createElement('article');
    el.className='card';
    el.innerHTML=`<div class=\"media\">${p.icon}</div>
      <div class=\"meta\">
        <span class=\"brand\">TESCO</span>
        <div class=\"title\">${p.name}</div>
        <div class=\"unit\">1 unit</div>
        <div class=\"price-row\">
          <div class=\"price\">$${(+p.price).toFixed(2)}</div>
          <button class=\"add\" data-id=\"${p.id}\">Add</button>
        </div>
      </div>`;
    return el;
  }
  function renderGrid(){ if(!gridEl) return; gridEl.innerHTML=''; PRODUCTS.forEach(p=>gridEl.appendChild(card(p))); }
  renderGrid();

  const cart = new Map();
  const cartCountEl = document.getElementById('cartCount');
  const cartList = document.getElementById('cartList');
  const checkoutTotal = document.getElementById('checkoutTotal');
  function money(n){ return `$${(+n).toFixed(2)}` }
  function calc(){ let items=0,total=0; cart.forEach((q,id)=>{ const p=PRODUCTS.find(x=>x.id===id); items+=q; total+=q*+p.price; }); return {items,total}; }
  function updateCart(){
    const {items,total}=calc();
    if(cartCountEl) cartCountEl.textContent=items;
    if(checkoutTotal) checkoutTotal.textContent=money(total);
    if(cartList){ cartList.innerHTML=''; cart.forEach((q,id)=>{ const p=PRODUCTS.find(x=>x.id===id); const row=document.createElement('div'); row.className='cart-item'; row.innerHTML=`<div>${p.icon} ${p.name}</div><div class=\"qty\"><button data-act=\"dec\" data-id=\"${id}\">-</button><span>${q}</span><button data-act=\"inc\" data-id=\"${id}\">+</button></div><div>${money(+p.price*q)}</div>`; cartList.appendChild(row); }); }
  }
  function toast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent='‚úì '+msg; t.style.transform='translateX(0)'; setTimeout(()=>t.style.transform='translateX(120%)',2000); }
  if(gridEl){ gridEl.addEventListener('click',e=>{ if(e.target.classList.contains('add')){ const id=e.target.dataset.id; cart.set(id,(cart.get(id)||0)+1); updateCart(); const p=PRODUCTS.find(x=>x.id===id); toast(p.name+' added'); } }); }
  if(cartList){ cartList.addEventListener('click',e=>{ if(e.target.dataset.act==='inc'){ const id=e.target.dataset.id; cart.set(id,(cart.get(id)||0)+1); updateCart(); } if(e.target.dataset.act==='dec'){ const id=e.target.dataset.id; const q=(cart.get(id)||0)-1; if(q>0) cart.set(id,q); else cart.delete(id); updateCart(); } }); }
  function cartCheckoutUrl(){
    const items = Array.from(cart.entries()).map(([id,qty])=>({id,qty}));
    const enriched = items.map(it=>{ const p=PRODUCTS.find(x=>x.id===it.id)||{}; return {id:it.id, name:p.name||it.id, qty:it.qty||1, price:+(p.price||0)}; });
    const total = +enriched.reduce((s,i)=>s+i.price*i.qty,0).toFixed(2);
    const payload = encodeURIComponent(JSON.stringify({items: enriched, total}));
    return PAYPAL_STAGE_URL+`&mock_payload=${payload}`;
  }
  function renderPayPalButton(){ const c=document.getElementById('paypal-button-container'); if(!c) return; c.innerHTML='<button id=\"ppbtn\" class=\"pp-btn\" type=\"button\">Pay with PayPal</button>'; const btn=document.getElementById('ppbtn'); btn&&btn.addEventListener('click', ()=>{ const {total}=calc(); if(total<=0){ alert('Your cart is empty.'); return; } window.location.href = cartCheckoutUrl(); }); }
  renderPayPalButton(); updateCart();

function openChat(){
    chatPanel.style.display='flex';
    requestAnimationFrame(()=>{
      chatPanel.classList.add('open');
      chatBackdrop.classList.add('show');
    });
    bootChat();
  }
  function closeChat(){
    chatPanel.classList.remove('open');
    chatBackdrop.classList.remove('show');
    setTimeout(()=>{ chatPanel.style.display='none'; }, 250);
  }
  chatFab.onclick = openChat;
  chatClose.onclick = closeChat;
  chatBackdrop.onclick = closeChat;

  // Swipe-to-close (mobile Safari friendly)
  let startY=null, currentY=null, dragging=false;
  chatPanel.addEventListener('touchstart',(e)=>{
    if(e.touches.length!==1) return; startY=e.touches[0].clientY; dragging=true; chatPanel.style.transition='none';
  });
  chatPanel.addEventListener('touchmove',(e)=>{
    if(!dragging) return; currentY=e.touches[0].clientY; const dy=Math.max(0, currentY-startY); chatPanel.style.transform=`translateY(${dy}px)`;
  });
  chatPanel.addEventListener('touchend',()=>{
    if(!dragging) return; dragging=false; chatPanel.style.transition=''; const dy=Math.max(0,(currentY||0)-(startY||0)); if(dy>120){ closeChat(); chatPanel.style.transform=''; } else { chatPanel.style.transform=''; chatPanel.classList.add('open'); }
  });

  function addMsg(text, who='bot'){
    const div = document.createElement('div');
    div.className = 'msg '+who;
    div.innerHTML = text;
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function showProducts(list){
    let html = '<div>'; 
    list.forEach(p=>{
      const url = PAYPAL_STAGE_URL+"&mock_item="+encodeURIComponent(p.name)+"&mock_price="+p.price;
      html += `<div class='product'>${p.icon} <span class='product-title'>${p.name}</span><br/>Category: ${p.category}<br/>Price: $${p.price}<br/><a class='pp-link' href='${url}' target='_self'>Checkout with PayPal</a></div>`;
    });
    html += '</div>';
    addMsg(html,'bot');
  }

  function bootChat(){
    if(chatBody.dataset.boot) return;
    chatBody.dataset.boot = '1';
    addMsg("Hi! Ask me for products, e.g. 'show snacks under $10'.",'bot');
  }

  function handleChatSend(){
    const text = chatInput.value.trim();
    if(!text) return;
    addMsg(text,'user');
    chatInput.value='';
    // Mock LLM: filter products
    let list = PRODUCTS.slice();
    const m = text.match(/under\s*\$?(\d+(?:\.\d+)?)/i);
    if(m){ const cap = parseFloat(m[1]); list = list.filter(p=>p.price <= cap); }
    for(const cat of categories){
      if(text.toLowerCase().includes(cat.toLowerCase())){
        list = list.filter(p=>p.category===cat);
      }
    }
    list = list.slice(0,5);
    if(list.length) showProducts(list);
    else addMsg("Sorry, no products found.", 'bot');
  }

  chatForm.addEventListener('submit', function(e){ e.preventDefault(); handleChatSend(); });
  chatSend.addEventListener('click', handleChatSend);
</script>
</body>
</html>
